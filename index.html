<!DOCTYPE html>
<html>
<head>
    <title>Weather Prediction Task</title>
    <meta charset="UTF-8">
    
    <!-- jsPsych -->
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-select@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        .card-icon-inline {
            width: 40px;
            height: 60px;
            object-fit: contain;
            vertical-align: middle;
            margin: 0 5px;
        }
        
        /* Consent form styling */
        .consent-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px;
            text-align: left;
        }
        .consent-content {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        .consent-content h3 {
            color: #003f87;
            margin-top: 20px;
        }
        .consent-content ul {
            padding-left: 25px;
        }
        .consent-checkbox {
            margin: 20px 0;
            font-size: 16px;
        }
        .consent-checkbox input {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        /* Slider styling */
        .slider-container {
            margin: 20px 0;
        }
        .slider-label {
            font-size: 16px;
            margin-bottom: 10px;
        }
        input[type="range"] {
            width: 100%;
            height: 8px;
            margin: 10px 0;
        }
        .slider-value {
            font-size: 18px;
            font-weight: bold;
            color: #003f87;
            text-align: center;
            margin-top: 5px;
        }
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }
        
        /* Drag-and-drop ranking styling */
        .ranking-container {
            max-width: 500px;
            margin: 30px auto;
        }
        .ranking-instructions {
            font-size: 18px;
            margin-bottom: 20px;
            text-align: center;
        }
        .ranking-list {
            list-style: none;
            padding: 0;
        }
        .ranking-item {
            background: white;
            border: 2px solid #003f87;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: move;
            display: flex;
            align-items: center;
            font-size: 18px;
            transition: all 0.2s;
        }
        .ranking-item:hover {
            background: #f0f8ff;
            transform: scale(1.02);
        }
        .ranking-item.dragging {
            opacity: 0.5;
        }
        .drag-handle {
            margin-right: 15px;
            font-size: 24px;
            color: #666;
        }
        .ranking-position {
            margin-right: 15px;
            font-weight: bold;
            color: #003f87;
            font-size: 20px;
        }
    </style>
</head>
<body></body>
<script>

// ==============================================================================
// FIREBASE CONFIGURATION
// IMPORTANT: Replace with YOUR Firebase config
// ==============================================================================

const firebaseConfig = {

  apiKey: "AIzaSyDybTzOtak37BlWGP-3uK_6Ig1HJvFbgm0",

  authDomain: "weather-prediction-study.firebaseapp.com",

  projectId: "weather-prediction-study",

  storageBucket: "weather-prediction-study.firebasestorage.app",

  messagingSenderId: "8161430272",

  appId: "1:8161430272:web:ccf2cb1a9f8a51c9b601e5"

};


firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ==============================================================================
// EXPERIMENT SETUP
// ==============================================================================

var urlParams = new URLSearchParams(window.location.search);
var subject_id = urlParams.get('id') || 
                 urlParams.get('survey_code') || 
                 'TEST_' + Date.now();

var SONA_REDIRECT_URL = 'https://ucsd.sona-systems.com/webstudy_credit.aspx?experiment_id=3010&credit_token=2e8c024ee0554bf48148479aa54fffea&survey_code=' + subject_id;

var jsPsych = initJsPsych({
    show_progress_bar: true,
    on_finish: function() {
        var allData = jsPsych.data.get().values();
        
        db.collection('participants').doc(subject_id).set({
            participant_id: subject_id,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            data: allData
        })
        .then(function() {
            console.log("✓ Data saved to Firebase successfully!");
            var timestamp = new Date().toISOString().slice(0,10);
            jsPsych.data.get().localSave('csv', 'weather-prediction-' + subject_id + '-' + timestamp + '.csv');
            
            // Uncomment when ready for SONA:
            setTimeout(function() {
            window.location = SONA_REDIRECT_URL;
            }, 2000);
        })
        .catch(function(error) {
            console.error("✗ Error saving to Firebase:", error);
            alert("Error saving data. Please contact the researcher.");
        });
    }
});

jsPsych.data.addProperties({
    participant_id: subject_id
});

// ==============================================================================
// STIMULI
// ==============================================================================

var cardImages = {
    1: 'triangle.png',
    2: 'circle.png',
    3: 'diamond.png',
    4: 'square.png'
};

var trialStructure = [
    ['A', [4], 17, 2],
    ['B', [3], 7, 2],
    ['C', [3,4], 24, 2],
    ['D', [2], 2, 7],
    ['E', [2,4], 10, 2],
    ['F', [2,3], 3, 3],
    ['G', [2,3,4], 17, 2],
    ['H', [1], 2, 17],
    ['I', [1,4], 3, 3],
    ['J', [1,3], 2, 10],
    ['K', [1,3,4], 5, 4],
    ['L', [1,2], 2, 24],
    ['M', [1,2,4], 4, 5],
    ['N', [1,2,3], 2, 17]
];

function generateTrials() {
    var allTrials = [];
    for (var t = 0; t < trialStructure.length; t++) {
        var structure = trialStructure[t];
        var pattern = structure[0];
        var cards = structure[1].slice();
        var sunCount = structure[2];
        var rainCount = structure[3];
        
        for (var i = 0; i < sunCount; i++) {
            allTrials.push({
                pattern: pattern,
                cards: cards.slice(),
                correctOutcome: 'sun'
            });
        }
        for (var i = 0; i < rainCount; i++) {
            allTrials.push({
                pattern: pattern,
                cards: cards.slice(),
                correctOutcome: 'rain'
            });
        }
    }
    return jsPsych.randomization.shuffle(allTrials);
}

var trials = generateTrials();

// ==============================================================================
// CONSENT FORM
// ==============================================================================

var consent = {
    type: jsPsychHtmlButtonResponse,
    stimulus: function() {
        return '<div class="consent-container">' +
            '<h2 style="color: #003f87; text-align: center;">UNIVERSITY OF CALIFORNIA, SAN DIEGO<br>CONSENT TO PARTICIPATE IN RESEARCH</h2>' +
            '<div class="consent-content">' +
            '<h3>1. Study Title and Number</h3>' +
            '<p><strong>Title:</strong> Implicit Prediction in Autistic Adults<br><strong>Study #:</strong> 813724</p>' +
            
            '<h3>2. Principal Investigator</h3>' +
            '<p>Leslie Carver, Provost, Professor, Thurgood Marshall College</p>' +
            
            '<h3>3. Contact Information</h3>' +
            '<p>PI phone number: 858-757-4513</p>' +
            
            '<h3>5. Study Overview</h3>' +
            '<p>This research study is being conducted to understand how autistic and neurotypical adults learn to respond to implicit predictive cues.</p>' +
            '<p>We are inviting you to participate in a research study because you are an autistic or neurotypical adult (over the age of 18).</p>' +
            '<p><strong>This form explains the research so that you may make an informed decision about participating.</strong></p>' +
            '<ul>' +
            '<li>Research is voluntary - whether or not you participate is your decision.</li>' +
            '<li>You can say yes, but change your mind later.</li>' +
            '<li>If you say no, we will not hold your decision against you.</li>' +
            '<li>Your decision will not affect your health care or other benefits you may be entitled to.</li>' +
            '<li>Please ask the study team questions about anything that is not clear.</li>' +
            '<li>You will be given a copy of this consent form and the Participant\'s Bill of Rights.</li>' +
            '</ul>' +
            '<p><strong>Purpose:</strong> To understand how autistic and neurotypical adults make predictive decisions.</p>' +
            '<p><strong>Common risks:</strong> Boredom and fatigue. The most serious risk is loss of confidentiality.</p>' +
            '<p><strong>Benefits:</strong> No direct benefits to you. Possible benefits to others include obtaining greater knowledge about autism and informing better interventions.</p>' +
            
            '<h3>6. Whom can I talk to if I have questions?</h3>' +
            '<p>If you have questions or concerns during your participation, contact the research team at 858-757-4513.</p>' +
            '<p>If you have questions about your rights as a research participant, contact:</p>' +
            '<ul><li>UC San Diego Office of IRB Administration at 858-246-4777 or irb@ucsd.edu</li></ul>' +
            
            '<h3>7. How many people will take part?</h3>' +
            '<p>The research will include 120 participants.</p>' +
            
            '<h3>8. What happens if I take part in the research?</h3>' +
            '<p>You will complete a task on the computer where you will be asked to make predictions based on some cues. You will then answer questions about your language development, autism diagnosis (if applicable), and general demographic information (age, sex, etc). This study will take place online remotely.</p>' +
            
            '<h3>9. What are the risks and possible discomforts?</h3>' +
            '<p>Participation in this study may involve:</p>' +
            '<ul>' +
            '<li>Boredom</li>' +
            '<li>Being recorded</li>' +
            '<li>Loss of confidential information</li>' +
            '<li>Collection of sensitive information</li>' +
            '</ul>' +
            '<p><strong>Risks of Loss of Confidential Information:</strong> There is a risk that information about you could be released to an unauthorized party. To minimize this risk, we will deidentify data and store it on locked devices. Only necessary members of the research team who are trained on confidentiality will have access to the data.</p>' +
            '<p><strong>Risks of Collection of Sensitive Information:</strong> Some of the information we will ask you to provide is personal. You may feel embarrassed or stressed.</p>' +
            '<p><strong>Possible Unknown Risks:</strong> There might be risks that we cannot predict at this time. You will be informed of any new findings that might affect your health or welfare.</p>' +
            
            '<h3>10. How will information about me be protected?</h3>' +
            '<p>While we cannot guarantee complete confidentiality, we will limit access to information about you. Only people who have a need to review your information will have access.</p>' +
            '<p>Study information will be labeled with a code instead of your name. The record linking your identifying information and the code will be kept separate from the rest of the study information.</p>' +
            '<p>The results of this study may be published once completed. However, we will keep your name and other identifying information confidential.</p>' +
            
            '<h3>11. Will I need to pay to participate?</h3>' +
            '<p>There will be no cost to you for participating in this study.</p>' +
            
            '<h3>12. What if I agree to participate, but change my mind later?</h3>' +
            '<p>You can stop participating at any time for any reason, and it will not be held against you. No matter what you decide, there will be no penalty to you.</p>' +
            
            '<h3>13. What will happen to information collected from me?</h3>' +
            '<p>The data we collect may be used to answer other research questions or may be shared with other investigators for other research. If we do so, we will remove all identifiable information before use or sharing.</p>' +
            
            '<h3>15. Will I be compensated for participating?</h3>' +
            '<p>If you agree to participate in this research, you will receive either $10 or 1 SONA credit after completion of the whole study.</p>' +
            
            '<h3>16. What else is important for me to know?</h3>' +
            '<p>You will not be provided any clinically relevant information that may pertain to your health. You will not be provided a summary of the research findings.</p>' +
            
            '<h3>17. What are my rights when providing electronic consent?</h3>' +
            '<p>California law provides specific rights when you are asked to provide electronic consent:</p>' +
            '<ul>' +
            '<li>You have the right to obtain a copy of the consent document in a non-electronic format.</li>' +
            '<li>You have the right to provide consent in a non-electronic format.</li>' +
            '<li>If you change your mind about electronic consent, you have the right to request your electronic consent to be withdrawn.</li>' +
            '</ul>' +
            
            '<h3>Experimental Participant\'s Bill of Rights</h3>' +
            '<p><strong>Every individual asked to participate in a research study has the right to be:</strong></p>' +
            '<ol>' +
            '<li>Informed about the nature and purpose of the study.</li>' +
            '<li>Provided an explanation of the procedures to be followed.</li>' +
            '<li>Given a description of any side effects, discomforts, or risks.</li>' +
            '<li>Informed about any benefits that would reasonably be expected.</li>' +
            '<li>Informed of any alternative procedures, drugs, or devices.</li>' +
            '<li>Told of the types of medical treatment available if complications arise.</li>' +
            '<li>Provided an opportunity to ask questions at any time.</li>' +
            '<li>Informed that individuals can refuse to participate. Participation is voluntary.</li>' +
            '<li>Provided a copy of the signed and dated written consent form.</li>' +
            '<li>Given the opportunity to freely decide whether or not to consent without any force or coercion.</li>' +
            '</ol>' +
            '<p style="margin-top: 20px;"><strong>Contact Information:</strong></p>' +
            '<p>If you have concerns or questions, contact UC San Diego Office of IRB Administration at irb@ucsd.edu or 858-246-4777.</p>' +
            '</div>' +
            '<div class="consent-checkbox">' +
            '<label>' +
            '<input type="checkbox" id="consent-check" required>' +
            '<strong>I have read the above information. I agree to participate in the research described in this form.</strong>' +
            '</label>' +
            '</div>' +
            '</div>';
    },
    choices: ['I Agree and Consent to Participate'],
    button_html: '<button class="jspsych-btn" id="consent-btn" style="font-size: 18px; padding: 15px 40px;" disabled>%choice%</button>',
    on_load: function() {
        var checkbox = document.getElementById('consent-check');
        var button = document.getElementById('consent-btn');
        checkbox.addEventListener('change', function() {
            button.disabled = !this.checked;
        });
    },
    data: { task: 'consent' }
};

// ==============================================================================
// INSTRUCTIONS
// ==============================================================================

var instructions = {
    type: jsPsychInstructions,
    pages: [
        '<p style="font-size: 20px;">Thank you for participanting in our study!</p>' +
        '<p>You will see cards and predict whether it will be sunny or rainy.</p>' +
        '<p>After each prediction, you\'ll see the correct weather.</p>' +
        '<p>You might have to guess at first, but most people become better as the task progresses.</p>',
        
        '<p style="font-size: 20px;">How to respond:</p>' +
        '<p>Press <strong>F</strong> to predict RAINY weather</p>' +
        '<p>Press <strong>J</strong> to predict SUNNY weather</p>' +
        '<p>Please respond as quickly and accurately as possible.</p>',
        
        '<p style="font-size: 20px;">About the task:</p>' +
        '<p>There will be 200 trials total.</p>' +
        '<p>You will get short breaks after every 50 trials.</p>' +
        '<p>A progress bar at the top will show your progress.</p>' +
        '<p>Click "Next" when you are ready to begin!</p>'
    ],
    show_clickable_nav: true
};

// ==============================================================================
// BUILD TIMELINE
// ==============================================================================

var timeline = [];
timeline.push(consent);
timeline.push(instructions);

// Add all 200 trials
for (var idx = 0; idx < trials.length; idx++) {
    (function(index) {
        var trial = trials[index];
        
        if (index > 0 && index % 50 === 0 && index < 200) {
            timeline.push({
                type: jsPsychHtmlButtonResponse,
                stimulus: '<div style="text-align: center; padding: 40px;">' +
                          '<h2 style="font-size: 28px;">Take a Break!</h2>' +
                          '<p style="font-size: 20px;">You have completed ' + index + ' out of 200 trials.</p>' +
                          '<p style="font-size: 20px;">Take as much time as you need.</p>' +
                          '</div>',
                choices: ['Continue']
            });
        }
        
        var cardsHTML = '<div style="display: flex; justify-content: center; gap: 20px; min-height: 200px; align-items: center;">';
        for (var c = 0; c < trial.cards.length; c++) {
            cardsHTML += '<img src="' + cardImages[trial.cards[c]] + '" style="width: 120px; height: 180px;">';
        }
        cardsHTML += '</div>';
        cardsHTML += '<div style="font-size: 24px; margin-top: 30px; text-align: center; font-weight: bold;">Will it be sunny or rainy?</div>';
        cardsHTML += '<div style="display: flex; justify-content: center; gap: 100px; margin-top: 40px;">';
        cardsHTML += '  <div style="text-align: center;">';
        cardsHTML += '    <img src="rain.png" style="width: 100px; height: 100px; margin-bottom: 10px;">';
        cardsHTML += '    <div style="font-size: 18px; font-weight: bold;">Press F for Rainy</div>';
        cardsHTML += '  </div>';
        cardsHTML += '  <div style="text-align: center;">';
        cardsHTML += '    <img src="sun.png" style="width: 100px; height: 100px; margin-bottom: 10px;">';
        cardsHTML += '    <div style="font-size: 18px; font-weight: bold;">Press J for Sunny</div>';
        cardsHTML += '  </div>';
        cardsHTML += '</div>';
        
        timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: cardsHTML,
            choices: ['f', 'j'],
            trial_duration: 5000,
            data: {
                task: 'response',
                trial_number: index + 1,
                block: Math.floor(index / 50) + 1,
                pattern: trial.pattern,
                cards_shown: trial.cards.join(','),
                correct_outcome: trial.correctOutcome
            },
            on_load: function() {
                var hasResponded = false;
                var display = document.querySelector('#jspsych-html-keyboard-response-stimulus');
                
                var keyHandler = function(e) {
                    if (e.key === 'f' || e.key === 'j' || e.key === 'F' || e.key === 'J') {
                        hasResponded = true;
                    }
                };
                document.addEventListener('keydown', keyHandler);
                
                setTimeout(function() {
                    if (!hasResponded && display) {
                        var answerNow = document.createElement('div');
                        answerNow.style.cssText = 'color: red; font-size: 24px; margin-top: 30px; text-align: center; font-weight: bold;';
                        answerNow.textContent = 'Answer Now!';
                        display.appendChild(answerNow);
                    }
                }, 2000);
                
                setTimeout(function() {
                    document.removeEventListener('keydown', keyHandler);
                }, 5000);
            },
            on_finish: function(data) {
                if (data.response !== null) {
                    data.subject_response = data.response === 'j' ? 'sun' : 'rain';
                    data.correct = data.subject_response === data.correct_outcome;
                } else {
                    data.subject_response = null;
                    data.correct = false;
                }
            }
        });
        
        timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function() {
                var allData = jsPsych.data.get().values();
                var lastResponse = allData.filter(x => x.trial_number === index + 1 && x.task === 'response');
                var responded = lastResponse.length > 0 && lastResponse[lastResponse.length - 1].response !== null;
                
                var html = '<div style="display: flex; justify-content: center; gap: 20px; min-height: 200px; align-items: center;">';
                for (var c = 0; c < trial.cards.length; c++) {
                    html += '<img src="' + cardImages[trial.cards[c]] + '" style="width: 120px; height: 180px;">';
                }
                html += '</div>';
                html += '<div style="text-align: center; margin-top: 40px;">';
                html += '<img src="' + trial.correctOutcome + '.png" style="width: 300px; height: 300px;">';
                html += '</div>';
                
                if (!responded) {
                    html += '<div style="color: red; font-size: 20px; margin-top: 20px; text-align: center;">Too slow!</div>';
                }
                
                return html;
            },
            choices: "NO_KEYS",
            trial_duration: 2000,
            data: {
                task: 'feedback',
                trial_number: index + 1,
                block: Math.floor(index / 50) + 1
            }
        });
        
        timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '',
            choices: "NO_KEYS",
            trial_duration: 1000,
            data: { task: 'iti' }
        });
        
    })(idx);
}

// ==============================================================================
// POST-TASK QUESTIONNAIRE
// ==============================================================================

timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<div style="text-align: center; padding: 40px;">' +
              '<h2 style="font-size: 28px;">Task Complete!</h2>' +
              '<p style="font-size: 20px;">Great job! Now we have a few questions.</p>' +
              '</div>',
    choices: ['Continue']
});

// Q1 & Q2: Multi-select
timeline.push({
    type: jsPsychSurveyMultiSelect,
    questions: [{
        prompt: 'If the weather is <strong>sunny</strong>, what card is most likely to be present?',
        options: [
            '<img src="square.png" class="card-icon-inline"> ',
            '<img src="circle.png" class="card-icon-inline"> ',
            '<img src="triangle.png" class="card-icon-inline"> ',
            '<img src="diamond.png" class="card-icon-inline"> '
        ],
        required: true,
        name: 'sunny_cards'
    }],
    data: { task: 'questionnaire', question: 'q1' }
});

timeline.push({
    type: jsPsychSurveyMultiSelect,
    questions: [{
        prompt: 'If the weather is <strong>rainy</strong>, what card is most likely to be present?',
        options: [
            '<img src="square.png" class="card-icon-inline"> ',
            '<img src="circle.png" class="card-icon-inline"> ',
            '<img src="triangle.png" class="card-icon-inline"> ',
            '<img src="diamond.png" class="card-icon-inline"> '
        ],
        required: true,
        name: 'rainy_cards'
    }],
    data: { task: 'questionnaire', question: 'q2' }
});

// Q3-6: Card to weather
timeline.push({
    type: jsPsychSurveyMultiChoice,
    questions: [
        {
            prompt: 'If <img src="square.png" class="card-icon-inline"> is present, what weather is most likely?',
            options: ['Sunny', 'Rainy'],
            required: true,
            name: 'square_weather'
        },
        {
            prompt: 'If <img src="circle.png" class="card-icon-inline"> is present, what weather is most likely?',
            options: ['Sunny', 'Rainy'],
            required: true,
            name: 'circle_weather'
        },
        {
            prompt: 'If <img src="triangle.png" class="card-icon-inline"> is present, what weather is most likely?',
            options: ['Sunny', 'Rainy'],
            required: true,
            name: 'triangle_weather'
        },
        {
            prompt: 'If <img src="diamond.png" class="card-icon-inline"> is present, what weather is most likely?',
            options: ['Sunny', 'Rainy'],
            required: true,
            name: 'diamond_weather'
        }
    ],
    data: { task: 'questionnaire', question: 'q3_6' }
});

// Q7: Drag-and-drop ranking
timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: function() {
        return '<div class="ranking-container">' +
            '<div class="ranking-instructions">' +
            '<p style="font-size: 20px; font-weight: bold;">Rank these cards from most sunny (top) to least sunny (bottom)</p>' +
            '<p style="font-size: 16px; color: #666;">Click and drag to reorder</p>' +
            '</div>' +
            '<ul class="ranking-list" id="ranking-list">' +
            '<li class="ranking-item" draggable="true" data-card="square">' +
            '<span class="drag-handle">≡</span>' +
            '<span class="ranking-position">1.</span>' +
            '<img src="square.png" class="card-icon-inline"> Squares' +
            '</li>' +
            '<li class="ranking-item" draggable="true" data-card="diamond">' +
            '<span class="drag-handle">≡</span>' +
            '<span class="ranking-position">2.</span>' +
            '<img src="diamond.png" class="card-icon-inline"> Diamonds' +
            '</li>' +
            '<li class="ranking-item" draggable="true" data-card="circle">' +
            '<span class="drag-handle">≡</span>' +
            '<span class="ranking-position">3.</span>' +
            '<img src="circle.png" class="card-icon-inline"> Circles' +
            '</li>' +
            '<li class="ranking-item" draggable="true" data-card="triangle">' +
            '<span class="drag-handle">≡</span>' +
            '<span class="ranking-position">4.</span>' +
            '<img src="triangle.png" class="card-icon-inline"> Triangles' +
            '</li>' +
            '</ul>' +
            '</div>';
    },
    choices: ['Submit Ranking'],
    on_load: function() {
        var draggedItem = null;
        var list = document.getElementById('ranking-list');
        var items = list.querySelectorAll('.ranking-item');
        
        items.forEach(function(item) {
            item.addEventListener('dragstart', function() {
                draggedItem = this;
                setTimeout(function() {
                    draggedItem.classList.add('dragging');
                }, 0);
            });
            
            item.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                updatePositions();
            });
            
            item.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
            
            item.addEventListener('drop', function(e) {
                e.preventDefault();
                if (this !== draggedItem) {
                    var allItems = Array.from(list.children);
                    var draggedIndex = allItems.indexOf(draggedItem);
                    var targetIndex = allItems.indexOf(this);
                    
                    if (draggedIndex < targetIndex) {
                        this.parentNode.insertBefore(draggedItem, this.nextSibling);
                    } else {
                        this.parentNode.insertBefore(draggedItem, this);
                    }
                }
            });
        });
        
        function updatePositions() {
            var items = list.querySelectorAll('.ranking-item');
            items.forEach(function(item, index) {
                item.querySelector('.ranking-position').textContent = (index + 1) + '.';
            });
        }
    },
    on_finish: function(data) {
        var items = document.querySelectorAll('.ranking-item');
        var ranking = {};
        items.forEach(function(item, index) {
            var card = item.getAttribute('data-card');
            ranking['rank_' + card] = index + 1;
        });
        data.ranking = ranking;
    },
    data: { task: 'questionnaire', question: 'q7_ranking' }
});

// Q8: Probability sliders
timeline.push({
    type: jsPsychSurveyHtmlForm,
    preamble: '<p style="font-size: 20px; text-align: center;">What do you think the probability of sun is for each card?</p>' +
              '<p style="font-size: 16px; text-align: center; color: #666;">Use the sliders to indicate your estimate (0-100%)</p>',
    html: '<div class="slider-container">' +
          '<div class="slider-label"><img src="square.png" class="card-icon-inline"> <strong>Squares</strong></div>' +
          '<input type="range" id="prob_squares" name="prob_squares" min="0" max="100" value="50" step="1" required>' +
          '<div class="slider-labels"><span>0%</span><span>100%</span></div>' +
          '<div class="slider-value" id="value_squares">50%</div>' +
          '</div>' +
          '<div class="slider-container">' +
          '<div class="slider-label"><img src="circle.png" class="card-icon-inline"> <strong>Circles</strong></div>' +
          '<input type="range" id="prob_circles" name="prob_circles" min="0" max="100" value="50" step="1" required>' +
          '<div class="slider-labels"><span>0%</span><span>100%</span></div>' +
          '<div class="slider-value" id="value_circles">50%</div>' +
          '</div>' +
          '<div class="slider-container">' +
          '<div class="slider-label"><img src="triangle.png" class="card-icon-inline"> <strong>Triangles</strong></div>' +
          '<input type="range" id="prob_triangles" name="prob_triangles" min="0" max="100" value="50" step="1" required>' +
          '<div class="slider-labels"><span>0%</span><span>100%</span></div>' +
          '<div class="slider-value" id="value_triangles">50%</div>' +
          '</div>' +
          '<div class="slider-container">' +
          '<div class="slider-label"><img src="diamond.png" class="card-icon-inline"> <strong>Diamonds</strong></div>' +
          '<input type="range" id="prob_diamonds" name="prob_diamonds" min="0" max="100" value="50" step="1" required>' +
          '<div class="slider-labels"><span>0%</span><span>100%</span></div>' +
          '<div class="slider-value" id="value_diamonds">50%</div>' +
          '</div>',
    on_load: function() {
        var sliders = ['squares', 'circles', 'triangles', 'diamonds'];
        sliders.forEach(function(card) {
            var slider = document.getElementById('prob_' + card);
            var valueDisplay = document.getElementById('value_' + card);
            slider.addEventListener('input', function() {
                valueDisplay.textContent = this.value + '%';
            });
        });
    },
    data: { task: 'questionnaire', question: 'q8_probabilities' }
});

// Prior exposure questions
timeline.push({
    type: jsPsychSurveyMultiChoice,
    questions: [{
        prompt: 'Have you heard of or participated in the "Weather Prediction Task" before today?',
        options: ['Yes', 'No', 'I do not know'],
        required: true,
        name: 'prior_exposure'
    }],
    data: { task: 'questionnaire', question: 'prior_exposure' }
});

timeline.push({
    type: jsPsychSurveyHtmlForm,
    preamble: '<p style="font-size: 18px;">Please describe any previous experience you may have had with the Weather Prediction Task or similar tasks.</p>' +
              '<p style="font-size: 14px; color: #666;">For example: Have you completed this task before? Heard about it in a class? Read about it? Participated in a similar study?</p>' +
              '<p style="font-size: 14px; color: #666;">If you have no prior experience, you can write "None" or "N/A".</p>',
    html: '<textarea name="prior_experience_description" rows="5" cols="60" style="width: 100%; max-width: 600px; padding: 10px; font-size: 16px;" required></textarea>',
    data: { task: 'questionnaire', question: 'prior_experience_description' }
});

// ==============================================================================
// DEMOGRAPHICS
// ==============================================================================

timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<div style="text-align: center; padding: 40px;">' +
              '<p style="font-size: 20px;">Please answer a few questions about yourself, and then credit will be granted..</p>' +
              '</div>',
    choices: ['Continue']
});

// Age slider
timeline.push({
    type: jsPsychSurveyHtmlForm,
    preamble: '<p style="font-size: 18px; text-align: center;">What is your age?</p>',
    html: '<div class="slider-container" style="max-width: 500px; margin: 0 auto;">' +
          '<input type="range" id="age" name="age" min="18" max="100" value="25" step="1" required>' +
          '<div class="slider-labels"><span>18</span><span>100</span></div>' +
          '<div class="slider-value" id="value_age">25 years old</div>' +
          '</div>',
    on_load: function() {
        var slider = document.getElementById('age');
        var valueDisplay = document.getElementById('value_age');
        slider.addEventListener('input', function() {
            valueDisplay.textContent = this.value + ' years old';
        });
    },
    data: { task: 'demographics' }
});

// Other demographics
timeline.push({
    type: jsPsychSurveyMultiChoice,
    questions: [
        {
            prompt: 'What is your highest level of education?',
            options: [
                'Less than high school',
                'High school diploma/GED',
                'Some college (no degree)',
                "Associate's degree",
                "Bachelor's degree",
                "Master's degree",
                'Doctoral degree (PhD, EdD, etc.)',
                'Professional degree (MD, JD, etc.)'
            ],
            required: true,
            name: 'education'
        },
        {
            prompt: 'What is your sex assigned at birth?',
            options: ['Male', 'Female', 'Intersex'],
            required: true,
            name: 'sex'
        },
        {
            prompt: 'Have you been diagnosed with Autism Spectrum Disorder?',
            options: [
                'Diagnosed by a credentialed provider',
                'Self-diagnosed',
                'Not diagnosed'
            ],
            required: true,
            name: 'autism'
        }
    ],
    data: { task: 'demographics' }
});

// Final screen
timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<div style="text-align: center; padding: 40px;">' +
              '<h2>Study Complete!</h2>' +
              '<p>Thank you for participating!</p>' +
              '<p>Your data has been saved. Your SONA credit should apply automatically.</p>' +
              '</div>',
    choices: ['Finish']
});

// ==============================================================================
// RUN EXPERIMENT
// ==============================================================================

jsPsych.run(timeline);

</script>
</html>
